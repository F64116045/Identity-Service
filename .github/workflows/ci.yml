name: CI Pipeline

on:
  push:
    branches: [ "main", "dev", "feature/*" ]
  pull_request:
    branches: [ "main", "dev" ] 

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    # CI 專用的假資料，為了讓 Pydantic Settings 驗證通過
    env:
      ENVIRONMENT: test
      PROJECT_NAME: "Identity Service CI"
      SECRET_KEY: "test_secret_key_for_ci_pipeline_only"
      POSTGRES_SERVER: localhost
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: app
      REDIS_HOST: localhost

      GOOGLE_CLIENT_ID: "mock-google-client-id"
      GOOGLE_CLIENT_SECRET: "mock-google-client-secret"
      GOOGLE_REDIRECT_URI: "http://localhost:8000/api/v1/auth/google/callback"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"


      - name: Install uv
        uses: astral-sh/setup-uv@v1


      - name: Install dependencies
        run: |
          uv sync --all-extras


      - name: Create dummy certificates for testing
        run: |
          mkdir -p certs
          openssl genrsa -out certs/private.pem 2048
          openssl rsa -in certs/private.pem -outform PEM -pubout -out certs/public.pem

      - name: Run tests
        env:
          ENVIRONMENT: test
          PRIVATE_KEY_PATH: certs/private.pem
          PUBLIC_KEY_PATH: certs/public.pem
        run: |
          uv run pytest -v